<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.test.mybatis.IPostDAO">  <!-- 인터페이스 지정  -->
	<select id="postlist" resultType="com.test.mybatis.PostDTO" parameterType="String">
		SELECT POSTID, USERID, NICKNAME, TITLE, CONTENTS, GRADE, TELCERTIID, EMAILCERTIID, URL, BADURL, ADDRSIID, ADDRSINAME, ADDRSINAME, ADDRGUID, ADDRGUNAME, ADDRDETAIL, INTERMAINID, INTERMAINNAME, INTERSUBID, INTERSUBNAME, INTERDETAIL, MINNUM, MAXNUM, POSTDATE, MEETDATE, SAMEGENDER, DRINK, LIMITGRADE, MOOD MOODNAME
     	, NVL((SELECT ID FROM FOLLOW WHERE GIVEUSERID= #{followIds} AND TAKEUSERID=PV.USERID), 0) AS FOLLOWID
		FROM POST_VIEW2 PV
		WHERE POSTID = 'PT00002'
	</select>
	
	<select id="searchList" resultType="com.test.mybatis.PostDTO">
	<![CDATA[
		SELECT *
		FROM
		(
		SELECT FN_CAL_RANK(POSTID, #{userId}, #{keyword}) AS POSTGRADE 
		     , RANK() OVER(ORDER BY FN_CAL_RANK(POSTID, #{userId}, #{keyword}), MEETDATE DESC) AS POSTNUM
		     , POSTID, USERID, NICKNAME, URL, URLBAD
		     , TITLE, MINNUM, MAXNUM, CONTENTS
		     , ADDRSINAME, ADDRGUNAME, TO_CHAR(MEETDATE, 'YYYY/MM/DD HH24:MI') AS MEETDATE
		FROM POST_VIEW
		WHERE MEETDATE >= SYSDATE
		  AND (ADDRGUID LIKE '%'||#{addrGuId1} OR ADDRGUID IN (#{addrGuId2} ,#{addrGuId3}))
		  AND (INTERSUBID LIKE '%'||#{interSubId1} OR INTERSUBID IN (#{interSubId2} ,#{interSubId3}))
		  AND (#{minNum}<=MINNUM AND MAXNUM<=#{maxNum})
		  AND (TO_DATE(#{minMeetDate}, 'YYYY-MM-DD')<=MEETDATE AND MEETDATE<=TO_DATE(#{maxMeetDate}, 'YYYY-MM-DD'))
		  AND MOOD LIKE '%'||#{moodId}||'%'
		  AND LIMITGRADE>=#{limitGrade}
		  AND DRINK LIKE '%'||#{drinkId}||'%'
		  AND SAMEGENDER LIKE '%'||#{sameGenderId}||'%'
		)
		WHERE (6*#{pageNum}-5) <= POSTNUM AND POSTNUM < (6*#{pageNum}+1)
	]]>
	</select>
	
	<select id="mainHotList" resultType="com.test.mybatis.PostDTO">
	<![CDATA[
		SELECT POSTID, USERID, NICKNAME, TITLE, CONTENTS, MEETDATE, ADDRSINAME, ADDRGUNAME, URL, URLBAD
		FROM POST_VIEW
		WHERE MEETDATE>=SYSDATE
		  AND FN_POST_IS_ACCEPTED(POSTID)=0
		  AND INTERMAINID=(SELECT INTERMAINID
		                    FROM
		                    (
		                        SELECT IM.INTERMAINID, RANK() OVER(ORDER BY COUNT(*)) AS RANK
		                        FROM POST P JOIN INTEREST_SUB "IS" ON P.INTERSUBID="IS".INTERSUBID
		                                    JOIN INTEREST_MAIN IM ON "IS".INTERMAINID=IM.INTERMAINID
		                        WHERE P.MEETDATE>=SYSDATE
		                        GROUP BY IM.INTERMAINID
		                    )
		                    WHERE RANK=1)
		ORDER BY MEETDATE DESC
	]]>
	</select>
	
	<select id="mainRecommendList" resultType="com.test.mybatis.PostDTO">
	<![CDATA[
		SELECT POSTID, USERID, NICKNAME, TITLE, CONTENTS, MEETDATE, ADDRSINAME, ADDRGUNAME, URL, URLBAD
		FROM
		(
		    SELECT *
		    FROM POST_VIEW 
		    WHERE MEETDATE>=SYSDATE
		      AND FN_POST_IS_ACCEPTED(POSTID)=0
		    ORDER BY FN_CAL_RANK(POSTID, #{userId}, '||') DESC, MEETDATE DESC
		)
	]]>
	</select>

	<select id="mainApproachingList" resultType="com.test.mybatis.PostDTO">
	<![CDATA[
		SELECT *
		FROM
		(
		    SELECT POSTID, USERID, NICKNAME, TITLE, CONTENTS, MEETDATE, ADDRSINAME, ADDRGUNAME, URL, URLBAD
		    FROM POST_VIEW PV
		    WHERE FN_POST_IS_ACCEPTED(POSTID)=0
		      AND MEETDATE>=SYSDATE
		    ORDER BY MEETDATE DESC
		)
		WHERE ROWNUM<=5
	]]>
	</select>
	
</mapper>
